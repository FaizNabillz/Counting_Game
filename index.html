<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Vision Game - Multi Device</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ASAS & RESET --- */
        body { 
            margin: 0; 
            background-color: #2FA4E7; 
            font-family: 'Nunito', sans-serif; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            user-select: none; 
            -webkit-user-select: none;
            touch-action: none; 
        }

        /* --- SCREEN: START & WIN OVERLAY --- */
        .start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #2FA4E7;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s;
            padding: 20px; box-sizing: border-box;
        }
        
        .game-title {
            font-size: 5vw; /* Responsive font */
            color: white; 
            text-shadow: 4px 4px 0px #1565C0;
            margin-bottom: 30px;
            animation: bounceTitle 2s infinite;
            text-align: center;
            line-height: 1.1;
        }

        .btn-style {
            background-color: #FDD835;
            color: #333;
            font-size: 24px; font-weight: 900;
            padding: 15px 50px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 0 #F9A825;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-style:active { transform: translateY(8px); box-shadow: 0 0 0 #F9A825; }

        @keyframes bounceTitle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* --- LAYOUT UTAMA GAME --- */
        #game-container {
            display: none; 
            width: 100%; height: 100%;
            /* Default: Desktop Layout (Row) */
            flex-direction: row; 
        }

        /* Header Bar */
        .header-bar { 
            position: absolute; top: 0; left: 0; 
            background-color: #333; width: 100%; height: 50px; 
            display: flex; align-items: center; justify-content: space-between; 
            z-index: 10; padding-right: 15px; box-sizing: border-box; 
        }
        .yellow-tab { background-color: #FDD835; height: 100%; padding: 0 20px; display: flex; align-items: center; font-size: 18px; color: #333; font-weight: bold; border-bottom-right-radius: 20px; }
        .level-badge { color: white; font-size: 16px; font-weight: bold; background: #555; padding: 5px 12px; border-radius: 15px; }

        /* Left Panel (Buah) */
        .left-panel { 
            flex: 6; /* 60% width on desktop */
            background-color: #2FA4E7; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; 
            border-right: 4px solid #1565C0; 
        }
        .fruit-grid { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 10px; width: 90%; height: 80%; 
            margin-top: 50px; overflow-y: auto; /* Scroll jika terlalu banyak di skrin kecil */
        }
        .fruit { 
            font-size: 80px; /* Saiz asal desktop */
            cursor: pointer; transition: transform 0.1s; 
            filter: drop-shadow(2px 4px 0px rgba(0,0,0,0.1)); 
            -webkit-tap-highlight-color: transparent;
        }
        .fruit:active { transform: scale(0.9); }
        .eaten { opacity: 0.5; filter: grayscale(100%); transform: scale(0.9); }

        /* Right Panel (Controls & Canvas) */
        .right-panel { 
            flex: 4; /* 40% width on desktop */
            background-color: #FFFFFF; 
            display: flex; flex-direction: column; 
        }

        .top-section { padding: 10px; padding-top: 60px; flex-shrink: 0; }
        
        /* Grid Nombor */
        .num-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 5px; border: 2px solid #B3E5FC; padding: 5px; border-radius: 10px; 
        }
        .num-block { 
            aspect-ratio: 1.2; 
            background-color: white; color: #1976D2; 
            font-size: 24px; font-weight: bold; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid #E1F5FE; border-radius: 5px; cursor: pointer; 
        }
        .num-block:active { background-color: #BBDEFB; }

        .mid-toolbar { display: flex; padding: 5px 15px; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
        .icon-btn { border: 2px solid #E1F5FE; border-radius: 8px; width: 40px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }

        /* Canvas Area */
        .bottom-section { 
            flex: 1; /* Ambil baki ruang */
            background-color: #1976D2; 
            position: relative; overflow: hidden; 
            border-top: 4px solid #1565C0; 
            cursor: crosshair; 
            min-height: 200px; /* Minimum tinggi canvas */
        }
        canvas { display: block; width: 100%; height: 100%; position: absolute; z-index: 2; }
        
        .instruction-text { position: absolute; top: 40%; width: 100%; text-align: center; color: rgba(255,255,255,0.5); font-size: 18px; pointer-events: none; z-index: 1; }
        .status-msg { position: absolute; bottom: 25px; left: 0; width: 100%; text-align: center; color: #FFF; font-weight: bold; pointer-events: none; text-shadow: 1px 1px 2px black; z-index: 3; font-size: 24px; }
        .debug-msg { position: absolute; bottom: 5px; right: 5px; color: rgba(255,255,255,0.4); font-size: 10px; z-index: 3; pointer-events: none; }

        /* Star & Animation */
        .star-popup { 
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0); 
            z-index: 9999; pointer-events: none; 
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .star-show { transform: translate(-50%, -50%) scale(1); }
        .star-shape { font-size: 200px; color: #FFD600; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); }
        
        .wrong-flash { animation: shake 0.5s; border: 5px solid red !important; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }

        /* --- RESPONSIVE / MEDIA QUERIES (MAGIK BERLAKU DI SINI) --- */
        
        /* 1. Untuk Tablet Portrait & Mobile Besar (Lebar < 1024px) */
        @media (max-width: 1024px) {
            #game-container { flex-direction: column; } /* Susunan jadi Atas-Bawah */
            
            .left-panel {
                flex: none; /* Matikan flex ratio */
                height: 45%; /* Bahagian atas (buah) 45% skrin */
                width: 100%;
                border-right: none;
                border-bottom: 4px solid #1565C0;
            }
            .fruit-grid { margin-top: 60px; height: auto; padding-bottom: 10px; }
            .fruit { font-size: 65px; } /* Kecilkan buah sikit */

            .right-panel {
                flex: none;
                height: 55%; /* Bahagian bawah 55% skrin */
                width: 100%;
            }
            .top-section { padding-top: 10px; } /* Kurangkan padding atas */
            .num-block { font-size: 20px; aspect-ratio: 1.5; } /* Butang leper sikit */
        }

        /* 2. Untuk Telefon Pintar (Mobile Kecil / Lebar < 600px) */
        @media (max-width: 600px) {
            .game-title { font-size: 40px; }
            
            .left-panel { height: 40%; } /* Ruang buah lebih kecil */
            .right-panel { height: 60%; } /* Ruang tulis lebih besar */
            
            .fruit-grid { gap: 5px; margin-top: 55px; }
            .fruit { font-size: 55px; } /* Buah sesuai untuk jari */
            
            .num-grid { gap: 3px; }
            .num-block { font-size: 18px; aspect-ratio: 1.3; border-radius: 4px; }
            
            .star-shape { font-size: 150px; } /* Bintang tak terlalu besar */
            
            .instruction-text { font-size: 14px; }
        }

        /* 3. Untuk Mode Landscape di Telefon (Bila telefon dipusing) */
        @media (max-height: 500px) and (orientation: landscape) {
            #game-container { flex-direction: row; }
            .left-panel { width: 50%; height: 100%; border-bottom: none; border-right: 4px solid #1565C0; }
            .right-panel { width: 50%; height: 100%; }
            .fruit { font-size: 50px; }
            .top-section { padding-top: 55px; }
            .num-block { height: 35px; font-size: 16px; }
        }

    </style>
</head>
<body>

    <div class="start-overlay" id="start-screen">
        <div class="game-title">Jom Kira<br>Buah! üçé</div>
        <button class="btn-style" onclick="startGameSession()">MULA</button>
    </div>

    <div id="game-container">
        <div class="header-bar">
            <div class="yellow-tab">Counting</div>
            <div class="level-badge" id="level-indicator">Lv 1/5</div>
        </div>

        <div class="left-panel">
            <div class="fruit-grid" id="fruit-area"></div>
        </div>

        <div class="right-panel" id="right-panel">
            <div class="top-section">
                <div class="num-grid">
                    <div class="num-block" onclick="checkAnswer(0)">0</div>
                    <div class="num-block" onclick="checkAnswer(1)">1</div>
                    <div class="num-block" onclick="checkAnswer(2)">2</div>
                    <div class="num-block" onclick="checkAnswer(3)">3</div>
                    <div class="num-block" onclick="checkAnswer(4)">4</div>
                    <div class="num-block" onclick="checkAnswer(5)">5</div>
                    <div class="num-block" onclick="checkAnswer(6)">6</div>
                    <div class="num-block" onclick="checkAnswer(7)">7</div>
                    <div class="num-block" onclick="checkAnswer(8)">8</div>
                    <div class="num-block" onclick="checkAnswer(9)">9</div>
                </div>
            </div>

            <div class="mid-toolbar">
                <div class="icon-btn" onclick="clearCanvas()">üóëÔ∏è</div>
            </div>

            <div class="bottom-section" id="canvas-container">
                <div class="instruction-text" id="hint">Tulis nombor...</div>
                <canvas id="writeCanvas"></canvas>
                <div class="status-msg" id="status"></div>
                <div class="debug-msg" id="debug"></div>
            </div>
        </div>
    </div>

    <div class="start-overlay" id="win-screen" style="display: none; opacity: 0;">
        <div class="game-title" style="font-size: 8vw;">TAHNIAH!<br>üéâ<br>Selesai!</div>
        <button class="btn-style" onclick="goHome()">MENU</button>
    </div>

    <div class="star-popup" id="win-star"><div class="star-shape">‚≠ê</div></div>

    <script>
        const fruitsData = ['üçé', 'üçä', 'üçå', 'üçì', 'üçá', 'üçâ'];
        let correctNum = 0;
        let isLocked = false;
        let countedFruits = 0;
        let currentLevel = 1;
        const maxLevels = 5;

        // --- GAME FLOW ---
        function startGameSession() {
            currentLevel = 1;
            updateLevelDisplay();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('win-screen').style.opacity = '0';
            
            const gameContainer = document.getElementById('game-container');
            gameContainer.style.display = 'flex'; // Flex ikut CSS media query
            
            // Penting: Tunggu sekejap untuk layout render sebelum resize canvas
            setTimeout(() => {
                resizeCanvas();
                initGame();
            }, 100);
            
            speak("Let's Play!");
        }

        function goHome() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('win-star').classList.remove('star-show');
            
            const startScreen = document.getElementById('start-screen');
            startScreen.style.display = 'flex';
            startScreen.style.opacity = '1';
        }

        function showWinScreen() {
            document.getElementById('win-star').classList.remove('star-show');
            speak("Congratulations!");
            document.getElementById('game-container').style.display = 'none';
            const winScreen = document.getElementById('win-screen');
            winScreen.style.display = 'flex';
            setTimeout(() => { winScreen.style.opacity = '1'; }, 50);
        }

        function updateLevelDisplay() {
            document.getElementById('level-indicator').innerText = `Lv ${currentLevel}/${maxLevels}`;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const msg = new SpeechSynthesisUtterance(text.toString());
                msg.lang = 'en-US'; msg.rate = 0.9; msg.pitch = 1.1;
                window.speechSynthesis.speak(msg);
            }
        }

        // --- DRAWING ENGINE ---
        const canvas = document.getElementById('writeCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('canvas-container');
        let isDrawing = false;
        let timer = null;
        let hasWritten = false;

        function resizeCanvas() {
            if(container.offsetWidth > 0 && container.offsetHeight > 0) {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                setupPen();
            }
        }
        function setupPen() {
            ctx.lineWidth = 15; // Sedikit nipis untuk skrin kecil
            ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#FFFFFF';
        }
        
        // Resize apabila skrin dipusing atau tingkap diubah
        window.addEventListener('resize', () => {
            resizeCanvas();
            // Optional: Simpan lukisan semasa resize (advanced), tapi clear pun ok
        });

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // Handle Touch vs Mouse
            let cx, cy;
            if(e.changedTouches) {
                cx = e.changedTouches[0].clientX;
                cy = e.changedTouches[0].clientY;
            } else {
                cx = e.clientX;
                cy = e.clientY;
            }
            return { x: cx - rect.left, y: cy - rect.top };
        }

        function startDraw(e) {
            if(isLocked) return;
            // Cegah scroll pada mobile semasa melukis
            if(e.cancelable) e.preventDefault(); 
            
            clearTimeout(timer);
            document.getElementById('hint').style.opacity = '0';
            document.getElementById('status').innerText = "";
            isDrawing = true; hasWritten = true;
            const pos = getPos(e);
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if(!isDrawing) return;
            if(e.cancelable) e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
        }

        function endDraw(e) {
            if(!isDrawing) return;
            if(e.cancelable) e.preventDefault();
            isDrawing = false;
            timer = setTimeout(recognizeGrid, 1000);
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        
        // Touch events mesti set passive: false untuk prevent scrolling
        canvas.addEventListener('touchstart', startDraw, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', endDraw, { passive: false });

        // --- VISION ENGINE ---
        const patterns = {
            '0': [1,1,1, 1,0,1, 1,1,1], '1': [0,1,0, 0,1,0, 0,1,0],
            '2': [1,1,1, 0,1,1, 1,1,1], '3': [1,1,1, 0,1,1, 1,1,1],
            '4': [1,0,1, 1,1,1, 0,0,1], '5': [1,1,1, 1,1,0, 1,1,1],
            '6': [1,0,0, 1,1,1, 1,1,1], '7': [1,1,1, 0,0,1, 0,0,1],
            '8': [1,1,1, 1,1,1, 1,1,1], '9': [1,1,1, 1,1,1, 0,0,1]
        };

        function recognizeGrid() {
            if(!hasWritten) return;
            const w = canvas.width, h = canvas.height;
            const imgData = ctx.getImageData(0,0,w,h).data;
            let minX=w, maxX=0, minY=h, maxY=0;
            let found = false;

            // Scan lebih laju (skip 5 pixel)
            for(let y=0; y<h; y+=5) {
                for(let x=0; x<w; x+=5) {
                    const i = (y*w + x) * 4;
                    if(imgData[i+3] > 0) {
                        if(x<minX) minX=x; if(x>maxX) maxX=x;
                        if(y<minY) minY=y; if(y>maxY) maxY=y;
                        found = true;
                    }
                }
            }

            if(!found || (maxX-minX < 20)) { document.getElementById('status').innerText = "?"; return; }

            const pad = 10;
            minX = Math.max(0, minX-pad); minY = Math.max(0, minY-pad);
            maxX = Math.min(w, maxX+pad); maxY = Math.min(h, maxY+pad);
            const bw = maxX - minX; const bh = maxY - minY;
            const cellW = bw/3; const cellH = bh/3;
            let grid = [0,0,0, 0,0,0, 0,0,0];

            for(let r=0; r<3; r++) {
                for(let c=0; c<3; c++) {
                    let hits = 0;
                    const samples = 15; // Kurangkan sample untuk mobile performance
                    for(let k=0; k<samples; k++) {
                        const sx = Math.floor(minX + c*cellW + Math.random()*cellW);
                        const sy = Math.floor(minY + r*cellH + Math.random()*cellH);
                        const idx = (sy*w + sx) * 4;
                        if(imgData[idx+3] > 50) hits++;
                    }
                    if(hits > (samples * 0.15)) grid[r*3+c] = 1;
                }
            }

            let bestNum = -1; let maxScore = -1;
            for(let n=0; n<=9; n++) {
                let score = 0;
                let pat = patterns[n.toString()];
                if(n===1) { if(grid[1] && grid[4] && grid[7] && !grid[0] && !grid[2]) score = 10; }
                else if(n===0) { if(!grid[4] && grid[0] && grid[8]) score = 10; }
                else { for(let i=0; i<9; i++) if(grid[i] === pat[i]) score++; }
                if(score > maxScore) { maxScore = score; bestNum = n; }
            }
            
            document.getElementById('debug').innerText = "V: " + bestNum;

            if(bestNum === correctNum) { checkAnswer(correctNum); } 
            else { triggerWrong(); }
        }

        // --- GAMEPLAY ---
        function initGame() {
            isLocked = false;
            countedFruits = 0;
            document.getElementById('win-star').classList.remove('star-show');
            document.getElementById('right-panel').classList.remove('wrong-flash');
            clearCanvas();
            updateLevelDisplay();
            
            correctNum = Math.floor(Math.random() * 9) + 1;
            let fruitType = fruitsData[Math.floor(Math.random() * fruitsData.length)];
            let container = document.getElementById('fruit-area');
            container.innerHTML = '';
            for(let i=0; i<correctNum; i++) {
                let f = document.createElement('div');
                f.className = 'fruit';
                f.textContent = fruitType;
                f.onclick = function() {
                    if(this.classList.contains('eaten')) return;
                    this.classList.add('eaten');
                    countedFruits++;
                    speak(countedFruits);
                };
                container.appendChild(f);
            }
        }

        function checkAnswer(num) {
            if(isLocked) return;
            if(num === correctNum) {
                isLocked = true;
                speak("Good Job!"); 
                document.getElementById('win-star').classList.add('star-show');
                document.getElementById('status').innerText = "CORRECT!";
                
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.font = "bold 100px Nunito"; ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(num, canvas.width/2, canvas.height/2);
                
                setTimeout(() => {
                    if(currentLevel >= maxLevels) { showWinScreen(); } 
                    else { currentLevel++; initGame(); }
                }, 3000); 
            } else {
                triggerWrong();
            }
        }

        function triggerWrong() {
            speak("Try Again");
            document.getElementById('status').innerText = "WRONG!";
            const panel = document.getElementById('right-panel');
            panel.classList.add('wrong-flash');
            setTimeout(() => {
                panel.classList.remove('wrong-flash');
                document.getElementById('status').innerText = "";
                if(!isDrawing) clearCanvas();
            }, 800);
        }

        function clearCanvas() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            document.getElementById('hint').style.opacity = '1';
            document.getElementById('status').innerText = "";
            document.getElementById('debug').innerText = "";
            hasWritten = false;
        }
    </script>
</body>
</html>
