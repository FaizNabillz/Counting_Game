<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jom Kira Buah - Pink Edition (2 Levels)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ASAS & RESET --- */
        body { margin: 0; background-color: #F48FB1; font-family: 'Nunito', sans-serif; height: 100vh; overflow: hidden; user-select: none; touch-action: none; }
        
        /* --- START & WIN SCREEN (Overlay) --- */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F48FB1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s;
            padding: 20px; box-sizing: border-box;
        }
        
        .game-title {
            font-size: clamp(40px, 8vw, 80px);
            color: white; 
            text-shadow: 4px 4px 0px #C2185B; 
            margin-bottom: 30px;
            animation: bounceTitle 2s infinite;
            text-align: center;
            line-height: 1.1;
        }

        /* Container untuk butang menu */
        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .btn-style {
            background-color: #FDD835;
            color: #333;
            font-size: clamp(20px, 5vw, 30px);
            font-weight: 900;
            padding: 15px 30px;
            width: 280px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 0 #F9A825;
            transition: transform 0.1s;
        }
        .btn-style:active { transform: translateY(8px); box-shadow: none; }

        /* Style Khas untuk butang Hard */
        .btn-hard {
            background-color: #C2185B;
            color: white;
            box-shadow: 0 8px 0 #880E4F;
        }
        
        @keyframes bounceTitle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* --- LAYOUT UTAMA --- */
        #game-container {
            display: none; 
            width: 100%; height: 100%;
            flex-direction: row; 
        }

        /* --- HEADER --- */
        .header-bar { 
            position: absolute; top: 0; left: 0; width: 100%; height: 50px; 
            display: flex; align-items: center; justify-content: space-between; 
            z-index: 10; pointer-events: none;
        }
        .yellow-tab { 
            background-color: #FDD835; height: 100%; padding: 0 20px; 
            display: flex; align-items: center; font-size: 18px; color: #333; font-weight: bold; 
            border-bottom-right-radius: 20px; pointer-events: auto;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .level-badge { 
            color: white; font-size: 16px; font-weight: bold; 
            background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 15px; 
            margin-right: 15px; pointer-events: auto;
        }

        /* --- PANEL KIRI (BUAH) --- */
        .left-panel { 
            flex: 65;
            background-color: #F48FB1; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; 
            border-right: 4px solid #C2185B; 
        }
        .fruit-grid { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 10px; width: 90%; height: 80%;
            overflow-y: auto;
        }
        .fruit { 
            font-size: clamp(40px, 8vw, 90px);
            cursor: pointer; transition: transform 0.1s; 
            filter: drop-shadow(2px 4px 0px rgba(0,0,0,0.1)); 
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .fruit:active { transform: scale(0.8); }
        .eaten { opacity: 0.4; filter: grayscale(100%); transform: scale(0.8); }

        /* --- PANEL KANAN (TULIS & NOMBOR) --- */
        .right-panel { 
            flex: 35;
            background-color: #FFFFFF; 
            display: flex; flex-direction: column; 
        }

        .top-section { padding: 10px; padding-top: 60px; flex-shrink: 0; }
        
        .num-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; 
            border: 2px solid #B3E5FC; padding: 5px; border-radius: 10px; 
        }
        .num-block { 
            aspect-ratio: 1; 
            background-color: white; color: #1976D2; 
            font-size: clamp(18px, 2vw, 30px); font-weight: bold; 
            display: flex; align-items: center; justify-content: center; 
            border: 2px solid #E1F5FE; border-radius: 5px; cursor: pointer; 
        }
        .num-block:active { background-color: #BBDEFB; }

        .mid-toolbar { display: flex; padding: 5px 10px; justify-content: flex-end; }
        .icon-btn { 
            border: 2px solid #E1F5FE; border-radius: 8px; width: 40px; height: 35px; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; 
        }

        .bottom-section { 
            flex: 1;
            background-color: #C2185B; position: relative; 
            overflow: hidden; border-top: 4px solid #C2185B; cursor: crosshair; 
        }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; position: absolute; z-index: 2; }
        
        .instruction-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; text-align: center; color: rgba(255,255,255,0.4); 
            font-size: 18px; pointer-events: none; z-index: 1; 
        }
        .status-msg { 
            position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center; 
            color: #FFF; font-weight: bold; pointer-events: none; 
            text-shadow: 1px 1px 2px black; z-index: 3; font-size: 20px; 
        }
        .debug-msg { position: absolute; bottom: 2px; right: 2px; color: rgba(255,255,255,0.3); font-size: 10px; z-index: 3; pointer-events: none; }

        /* BINTANG & ANIMASI */
        .star-popup { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            z-index: 9999; pointer-events: none; 
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .star-show { transform: translate(-50%, -50%) scale(1); }
        .star-shape { font-size: clamp(150px, 40vw, 250px); color: #FFD600; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); }
        
        .wrong-flash { animation: shake 0.5s; border: 5px solid red !important; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }

        /* --- MEDIA QUERIES (RESPONSIVE RULES) --- */
        @media (max-width: 768px) or (orientation: portrait) {
            #game-container { flex-direction: column; }
            
            .left-panel { 
                flex: none; height: 45%; width: 100%; 
                border-right: none; 
                border-bottom: 4px solid #C2185B; 
            }
            .fruit-grid { margin-top: 50px; }
            
            .right-panel { flex: 1; width: 100%; }
            
            .top-section { padding-top: 5px; padding-bottom: 5px; }
            .num-block { height: 40px; font-size: 20px; }
            
            .mid-toolbar { display: none; }
            
            .mobile-clear-btn {
                display: block !important;
                position: absolute; top: 10px; right: 10px; 
                background: rgba(255,255,255,0.2); color: white;
                border: 1px solid white; border-radius: 50%; width: 30px; height: 30px;
                text-align: center; line-height: 28px; font-size: 16px; z-index: 10;
            }
        }

        .mobile-clear-btn { display: none; }

    </style>
</head>
<body>

    <div class="overlay-screen" id="start-screen">
        <div class="game-title">Jom Kira<br>Buah! üçé</div>
        
        <div class="btn-container">
            <button class="btn-style" onclick="startGameSession('normal')">NORMAL (1-9)</button>
            <button class="btn-style btn-hard" onclick="startGameSession('hard')">HARD (Rawak)</button>
        </div>
    </div>

    <div id="game-container">
        <div class="header-bar">
            <div class="yellow-tab" id="mode-title">Counting</div>
            <div class="level-badge" id="level-indicator">1 / 9</div>
        </div>

        <div class="left-panel">
            <div class="fruit-grid" id="fruit-area"></div>
        </div>

        <div class="right-panel" id="right-panel">
            <div class="top-section">
                <div class="num-grid">
                    <div class="num-block" onclick="checkAnswer(0)">0</div>
                    <div class="num-block" onclick="checkAnswer(1)">1</div>
                    <div class="num-block" onclick="checkAnswer(2)">2</div>
                    <div class="num-block" onclick="checkAnswer(3)">3</div>
                    <div class="num-block" onclick="checkAnswer(4)">4</div>
                    <div class="num-block" onclick="checkAnswer(5)">5</div>
                    <div class="num-block" onclick="checkAnswer(6)">6</div>
                    <div class="num-block" onclick="checkAnswer(7)">7</div>
                    <div class="num-block" onclick="checkAnswer(8)">8</div>
                    <div class="num-block" onclick="checkAnswer(9)">9</div>
                </div>
            </div>

            <div class="mid-toolbar"><div class="icon-btn" onclick="clearCanvas()">üóëÔ∏è</div></div>

            <div class="bottom-section" id="canvas-container">
                <div class="instruction-text" id="hint">Tulis nombor</div>
                <div class="mobile-clear-btn" onclick="clearCanvas()">‚úñ</div>
                
                <canvas id="writeCanvas"></canvas>
                <div class="status-msg" id="status"></div>
                <div class="debug-msg" id="debug"></div>
            </div>
        </div>
    </div>

    <div class="overlay-screen" id="win-screen" style="display: none; opacity: 0;">
        <div class="game-title" style="font-size: clamp(40px, 8vw, 60px);">TAHNIAH!<br>üéâüéâüéâ</div>
        <button class="btn-style" onclick="goHome()">MENU UTAMA</button>
    </div>

    <div class="star-popup" id="win-star"><div class="star-shape">‚≠ê</div></div>

    <script>
        const fruitsData = ['üçé', 'üçä', 'üçå', 'üçì', 'üçá', 'üçâ'];
        let correctNum = 0;
        let isLocked = false;
        let countedFruits = 0;
        
        // --- LEVEL VARIABLES ---
        let currentRound = 1;
        const maxRounds = 9; // Setiap level ada 9 soalan
        let gameMode = 'normal'; 
        let questionSequence = []; // Menyimpan urutan soalan

        // --- SISTEM SUARA ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(text.toString());
                msg.lang = 'en-US'; msg.rate = 0.9; msg.pitch = 1.1;
                window.speechSynthesis.speak(msg);
            }
        }

        // --- PENGURUSAN SEQUENCE ---
        function generateSequence(mode) {
            // Asas nombor 1 hingga 9
            let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            
            if (mode === 'normal') {
                // Normal: Ikut urutan
                return nums;
            } else {
                // Hard: Rawakkan (Shuffle)
                for (let i = nums.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [nums[i], nums[j]] = [nums[j], nums[i]];
                }
                return nums;
            }
        }

        // --- GAME LOGIC ---
        function startGameSession(selectedMode) {
            gameMode = selectedMode;
            currentRound = 1;
            
            // Jana soalan
            questionSequence = generateSequence(gameMode);
            
            // UI Update
            if(gameMode === 'normal') {
                document.getElementById('mode-title').innerText = "Normal (1-9)";
            } else {
                document.getElementById('mode-title').innerText = "Hard (Rawak)";
            }

            updateLevelDisplay();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('win-screen').style.opacity = '0';
            
            const gameContainer = document.getElementById('game-container');
            gameContainer.style.display = 'flex';
            
            setTimeout(() => { resizeCanvas(); initGame(); }, 100);
            speak(gameMode === 'normal' ? "Normal Mode" : "Hard Mode");
        }

        function goHome() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('win-star').classList.remove('star-show');
            const startScreen = document.getElementById('start-screen');
            startScreen.style.display = 'flex';
            setTimeout(() => { startScreen.style.opacity = '1'; }, 50);
        }

        function showWinScreen() {
            document.getElementById('win-star').classList.remove('star-show');
            speak("Congratulations! You finished the level!");
            document.getElementById('game-container').style.display = 'none';
            const winScreen = document.getElementById('win-screen');
            winScreen.style.display = 'flex';
            setTimeout(() => { winScreen.style.opacity = '1'; }, 50);
        }

        function updateLevelDisplay() {
            // Papar Soalan ke berapa dari 9
            document.getElementById('level-indicator').innerText = `Q ${currentRound}/${maxRounds}`;
        }

        function initGame() {
            isLocked = false;
            countedFruits = 0;
            document.getElementById('win-star').classList.remove('star-show');
            document.getElementById('right-panel').classList.remove('wrong-flash');
            clearCanvas();
            updateLevelDisplay();
            
            // Ambil nombor berdasarkan urutan sequence
            // currentRound bermula dari 1, jadi array index ialah currentRound - 1
            correctNum = questionSequence[currentRound - 1];

            let fruitType = fruitsData[Math.floor(Math.random() * fruitsData.length)];
            let container = document.getElementById('fruit-area');
            container.innerHTML = '';
            for(let i=0; i<correctNum; i++) {
                let f = document.createElement('div');
                f.className = 'fruit';
                f.textContent = fruitType;
                f.onclick = function() {
                    if(this.classList.contains('eaten')) return;
                    this.classList.add('eaten');
                    countedFruits++;
                    speak(countedFruits);
                };
                container.appendChild(f);
            }
        }

        function checkAnswer(num) {
            if(isLocked) return;
            if(num === correctNum) {
                isLocked = true;
                speak("Good Job!"); 
                document.getElementById('win-star').classList.add('star-show');
                document.getElementById('status').innerText = "CORRECT!";
                
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.font = "bold 150px Nunito"; ctx.fillStyle = "white"; 
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(num, canvas.width/2, canvas.height/2);
                
                setTimeout(() => {
                    // Cek jika dah habis 9 soalan
                    if(currentRound >= maxRounds) {
                        showWinScreen();
                    } else { 
                        currentRound++; 
                        initGame(); 
                    }
                }, 3000); 
            } else {
                triggerWrong();
            }
        }

        function triggerWrong() {
            speak("Try Again");
            document.getElementById('status').innerText = "WRONG!";
            const panel = document.getElementById('right-panel');
            panel.classList.add('wrong-flash');
            setTimeout(() => {
                panel.classList.remove('wrong-flash');
                document.getElementById('status').innerText = "";
                if(!isDrawing) clearCanvas();
            }, 800);
        }

        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('writeCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('canvas-container');
        let isDrawing = false, timer = null, hasWritten = false;

        function resizeCanvas() {
            if(container.offsetWidth > 0) {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                ctx.lineWidth = 18; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#FFFFFF';
            }
        }
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener("orientationchange", function() {
            setTimeout(resizeCanvas, 200);
        });

        function clearCanvas() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            document.getElementById('hint').style.opacity = '1';
            document.getElementById('status').innerText = "";
            document.getElementById('debug').innerText = "";
            hasWritten = false;
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            let cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        }

        function startDraw(e) {
            if(isLocked) return;
            if(e.type !== 'mousedown') e.preventDefault();
            clearTimeout(timer);
            document.getElementById('hint').style.opacity = '0';
            document.getElementById('status').innerText = "";
            isDrawing = true; hasWritten = true;
            const pos = getPos(e);
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
        }
        function draw(e) {
            if(!isDrawing) return;
            if(e.type !== 'mousemove') e.preventDefault();
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
        }
        function endDraw(e) {
            if(!isDrawing) return;
            if(e.type !== 'mouseup') e.preventDefault();
            isDrawing = false;
            timer = setTimeout(recognizeGrid, 800);
        }

        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); canvas.addEventListener('touchend', endDraw, { passive: false });

        // --- VISION PATTERN MATCHING ---
        const patterns = {
            '0': [1,1,1, 1,0,1, 1,1,1], '1': [0,1,0, 0,1,0, 0,1,0],
            '2': [1,1,1, 0,1,1, 1,1,1], '3': [1,1,1, 0,1,1, 1,1,1],
            '4': [1,0,1, 1,1,1, 0,0,1], '5': [1,1,1, 1,1,0, 1,1,1],
            '6': [1,0,0, 1,1,1, 1,1,1], '7': [1,1,1, 0,0,1, 0,0,1],
            '8': [1,1,1, 1,1,1, 1,1,1], '9': [1,1,1, 1,1,1, 0,0,1]
        };

        function recognizeGrid() {
            if(!hasWritten) return;
            const w = canvas.width, h = canvas.height;
            const imgData = ctx.getImageData(0,0,w,h).data;
            let minX=w, maxX=0, minY=h, maxY=0, found = false;

            for(let y=0; y<h; y+=5) {
                for(let x=0; x<w; x+=5) {
                    if(imgData[(y*w + x)*4 + 3] > 0) {
                        if(x<minX) minX=x; if(x>maxX) maxX=x;
                        if(y<minY) minY=y; if(y>maxY) maxY=y;
                        found = true;
                    }
                }
            }
            if(!found || (maxX-minX < 20)) { document.getElementById('status').innerText = "?"; return; }

            const pad = 10;
            minX = Math.max(0, minX-pad); minY = Math.max(0, minY-pad);
            maxX = Math.min(w, maxX+pad); maxY = Math.min(h, maxY+pad);
            const cellW = (maxX-minX)/3, cellH = (maxY-minY)/3;
            let grid = [0,0,0, 0,0,0, 0,0,0];

            for(let r=0; r<3; r++) {
                for(let c=0; c<3; c++) {
                    let hits = 0;
                    for(let k=0; k<15; k++) {
                        const sx = Math.floor(minX + c*cellW + Math.random()*cellW);
                        const sy = Math.floor(minY + r*cellH + Math.random()*cellH);
                        if(imgData[(sy*w + sx)*4 + 3] > 50) hits++;
                    }
                    if(hits > 2) grid[r*3+c] = 1;
                }
            }

            let bestNum = -1, maxScore = -1;
            for(let n=0; n<=9; n++) {
                let score = 0, pat = patterns[n.toString()];
                if(n===1) { if(grid[1]&&grid[4]&&grid[7]&&!grid[0]) score=10; }
                else if(n===0) { if(!grid[4]&&grid[0]&&grid[8]) score=10; }
                else { for(let i=0; i<9; i++) if(grid[i]===pat[i]) score++; }
                if(score > maxScore) { maxScore = score; bestNum = n; }
            }
            
            document.getElementById('debug').innerText = "Scan: " + bestNum;
            if(bestNum === correctNum) checkAnswer(correctNum);
            else triggerWrong();
        }
    </script>
</body>
</html>
